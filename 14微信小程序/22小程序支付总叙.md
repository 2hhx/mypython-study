## 小程序支付接口

小程序支付的交互图如下：

![小程序支付时序图](https://img2018.cnblogs.com/blog/1825659/201911/1825659-20191108180739607-1980653683.gif)

商户系统和微信支付系统主要交互：

1、小程序内调用登录接口，获取到用户的openid,api参见公共api【[小程序登录API](https://developers.weixin.qq.com/miniprogram/dev/api/open-
api/login/wx.login.html)】

2、商户server调用支付统一下单，api参见公共api【[统一下单API](https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=9_1&index=1)】

3、商户server调用再次签名，api参见公共api【[再次签名](https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_7&index=3)】

4、商户server接收支付通知，api参见公共api【[支付结果通知API](https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=9_7)】

**下面的代码具体怎么用代码实现，我们再这里不讲，再后面文档中书写，我们先整理整体的业务逻辑**

### 1小程序登入API解释

**再之前的文档中我们已经对小程序的登入做了说明我们不在重复，如果有不懂的，可以参考前面的博客，如果不懂，可以再博客底下留言，我会第一时间回答**

### 2统一下单接口解释

​ 1当用户发起下单请求，且用户是登入状态的情况下，我们就可以创建我们商城的订单了。

​
2当订单创建完毕，我们应该发起支付，调用支付接口，也就是统一下单接口（这里的下单不是我们商城的下单，而是对微信官方进行支付下单），我们按照微信统一下单接口发送数据，微信下单接口会同步返回数据给我们，也就是上图中prepay_id

### 3再次签名

​ 1当我们拿到统一下的那数据以后，我们要再次进行签名（对数据加密以及处理）。

​ 2 然后将数据发送给我们小程序。

​ 3 小程序拿到我们发送的数据后调起支付界面，这样用户就可以进行支付了，如果支付成功，微信会直接返回 结果给我们小程序

### 4异步通知接口

​ 1在第三步再次签名中我们小程序已经知道用户是否支付成功，但是我们后端还不知道该订单是否支付成功

​ 2 基于1的问题，微信会以异步的方式通知我们后端程序，我们拿到微信异步通知的数据，我们就可以对订单 进行修改。那这样就实现了，前后都知道用户的支付结果。

