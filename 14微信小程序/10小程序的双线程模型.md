# 小程序的双线程模型

![](https://img2018.cnblogs.com/blog/1825659/201911/1825659-20191103201159055-398980633.webp)

![](file://E:/%E5%8D%9A%E5%AE%A2/%E9%A5%BC%E5%93%A5/%E5%B0%8F%E7%A8%8B%E5%BA%8F/medias/6943526-fbf86e46e9685211.webp?lastModify=1572437923)

**上图为官方文档给出的双线程模型**

## 小程序的宿主环境

**微信客户端** 微信客户端提供双线程去执行wxml,wxss，js文件。

### 双线程模型

1.上述的 **渲染层**
上面运行这wxml文件已经wxss文件，渲染层使用是的webview线程进行渲染（一个程序会有多个页面，也就会有多个view线程进行运作）

2.js文件是运行在逻辑层，逻辑层的js是通过jscore进行运行的。

### 通过双线程界面的渲染过程是怎样的？

##### wxml与DOM树

其实我们wxml文件与我们html中的DOM树是一样的，这样我们就可以有js来模拟一个虚拟的DOM树：

![](https://img2018.cnblogs.com/blog/1825659/201910/1825659-20191030202510772-1652100597.png)

![](file://E:/%E5%8D%9A%E5%AE%A2/%E9%A5%BC%E5%93%A5/%E5%B0%8F%E7%A8%8B%E5%BA%8F/medias/wxml%E4%B8%8EDOM%E6%A0%91.png?lastModify=1572437923)

##### 初始化渲染

![](https://img2018.cnblogs.com/blog/1825659/201910/1825659-20191030202547328-870219909.png)

如果我们的wxml文件中如果有变量：要与js逻辑层共同渲染页面成为一个真正的DOM树：

![](file://E:/%E5%8D%9A%E5%AE%A2/%E9%A5%BC%E5%93%A5/%E5%B0%8F%E7%A8%8B%E5%BA%8F/medias/%E5%88%9D%E6%AC%A1%E6%B8%B2%E6%9F%93.png?lastModify=1572437923)

##### 界面数据发生变化

![](https://img2018.cnblogs.com/blog/1825659/201910/1825659-20191030202640286-103241675.png)

![](file://E:/%E5%8D%9A%E5%AE%A2/%E9%A5%BC%E5%93%A5/%E5%B0%8F%E7%A8%8B%E5%BA%8F/medias/%E6%95%B0%E6%8D%AE%E6%94%B9%E5%8A%A8.png?lastModify=1572437923)

1如果通过setDat把hell改成dsb，则js对象的的节点会发生改变.

2 这时会用diff算法对比两个对象的变化，

3 然后将变化的部分应用到DOM树上

4 从而达到更新页面的目的，这也就是数据驱动的原理

##### 总结

**界面渲染的整体流程**

1在渲染层将wxml文件与wxss文件转化成js对象也就是虚拟DOM

2 在逻辑成将虚拟的DOM对象配合生成，真实的DOM树，在交给渲染层渲染

3 当数据变化是，逻辑层提供更新数据，js对象发生改变，用diff算法进行比较

4 将更新的内容，反馈到真实的DOM树中，更新页面

